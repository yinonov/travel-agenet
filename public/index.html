<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Travel Agent PoC</title>
  <style>
    :root{--b:#111827;--g:#f3f4f6;--bd:#e5e7eb}
    body{font-family:ui-sans-serif,system-ui;background:#fff;max-width:760px;margin:40px auto;padding:0 16px}
    form,.card{border:1px solid var(--bd);border-radius:12px;padding:16px;margin-bottom:16px;background:#fff}
    h1{margin-top:0}
    label{display:block;margin:8px 0 4px}
    input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 16px;border-radius:10px;border:0;background:var(--b);color:#fff;cursor:pointer}
    .muted{color:#6b7280}
    pre{white-space:pre-wrap;background:var(--g);padding:12px;border-radius:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .error{border-color:#fecaca;background:#fef2f2}
    .error-text{color:#b91c1c}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <h1>ðŸ§­ Travel Agent PoC</h1>
  <p class="muted">Enter a destination and dates; get a concise, structured plan. <em>(No real bookings.)</em></p>
  <label style="display:block;margin:8px 0"><input type="checkbox" id="ambientToggle"/> Show ambient suggestions</label>
  <div id="ambient" class="card" hidden>
    <h2>Ambient Suggestions</h2>
    <ul id="ambientList"></ul>
  </div>

  <div id="pg" class="card">
    <h2>Playground</h2>
    <div class="row" style="margin-bottom:8px">
      <button type="button" onclick="applyPreset('solo')">Solo City</button>
      <button type="button" onclick="applyPreset('family')">Family Fun</button>
      <button type="button" onclick="applyPreset('luxury')">Luxury</button>
    </div>
    <label>Destination <input id="pgDestination" type="text" placeholder="Bangkok, Thailand"/></label>
    <label>Travelers
      <div class="row">
        <input id="pgTravelers" type="range" min="1" max="10" value="2"/>
        <span id="pgTravelersOut">2</span>
      </div>
    </label>
    <label>Length (days)
      <div class="row">
        <input id="pgDays" type="range" min="1" max="30" value="3"/>
        <span id="pgDaysOut">3</span>
      </div>
    </label>
    <div id="pgEstimate" class="muted" style="margin:8px 0"></div>
    <div class="row">
      <button id="refine" type="button">Refine my trip</button>
    </div>
  </div>

    <form id="f" hidden>
      <label id="fld-destination" hidden>Destination <input name="destination" type="text" placeholder="Bangkok, Thailand"/></label>
      <label id="fld-start" hidden>Start <input name="start" type="date"/></label>
      <label id="fld-end" hidden>End <input name="end" type="date"/></label>
      <label id="fld-travelers" hidden>Travelers
        <div class="row">
          <input name="travelers" type="range" min="1" max="10" value="2"/>
          <span id="travelersOut">2</span>
        </div>
      </label>
      <label id="fld-budget" hidden>Budget (USD)
        <div class="row">
          <input name="budgetUSD" type="range" min="500" max="10000" step="100" value="2000"/>
          <span id="budgetOut">2000</span>
        </div>
      </label>
      <div id="estimate" class="muted" style="margin:8px 0" hidden></div>
      <div class="row">
        <button id="submit" type="submit">Get Suggestion</button>
        <span id="loading" class="muted" hidden>Loadingâ€¦</span>
        <span class="muted right">Disclaimer: generated ideas only â€” no bookings.</span>
      </div>
  </form>

  <div id="err" class="card error" hidden>
    <strong class="error-text">Something went wrong</strong>
    <div id="errmsg" class="error-text muted" style="margin-top:6px"></div>
    <div class="row" style="margin-top:8px">
      <button id="retry">Retry</button>
    </div>
  </div>

  <div id="out" class="card" hidden>
    <h2>Plan</h2>
    <div id="summary"></div>
    <div id="reasoning" class="muted" style="margin-top:4px"></div>
    <h3>Hotel ideas</h3>
    <ul id="hotels"></ul>
    <h3>Flight notes</h3>
    <div id="flight"></div>
    <h3>Must-do</h3>
    <ul id="todo"></ul>
    <hr/>
    <details>
      <summary>Raw JSON</summary>
      <div class="row" style="margin:8px 0">
        <button id="copy">Copy JSON</button>
        <span id="copied" class="muted" hidden>Copied!</span>
      </div>
      <pre id="raw"></pre>
    </details>
  </div>

  <div id="hist" class="card" hidden>
    <h2>Recent Queries</h2>
    <ul id="histlist"></ul>
  </div>

  <script>
    const f = document.getElementById('f');
      const out = (id)=>document.getElementById(id);

    // Playground elements
    const pg = {
      card: out('pg'),
      destination: out('pgDestination'),
      travelers: out('pgTravelers'),
      days: out('pgDays'),
      travelersOut: out('pgTravelersOut'),
      daysOut: out('pgDaysOut'),
      estimate: out('pgEstimate'),
      refine: out('refine')
    };

    let currentPrefs = { comfort: 0.33, cost: 0.33, speed: 0.34 };
    const presets = {
      solo: { destination: 'Tokyo, Japan', days: 5, preferences: { comfort: 0.3, cost: 0.5, speed: 0.2 } },
      family: { destination: 'Orlando, Florida', days: 7, preferences: { comfort: 0.5, cost: 0.3, speed: 0.2 } },
      luxury: { destination: 'Paris, France', days: 4, preferences: { comfort: 0.6, cost: 0.2, speed: 0.2 } }
    };
    function applyPreset(name) {
      const p = presets[name];
      if (!p) return;
      pg.destination.value = p.destination;
      pg.days.value = p.days;
      currentPrefs = p.preferences;
      updatePgOut();
      fetchPgEstimate();
    }

    const updatePgOut = ()=>{
      pg.travelersOut.textContent = pg.travelers.value;
      pg.daysOut.textContent = pg.days.value;
    };
    const fetchPgEstimate = async ()=>{
      const destination = pg.destination.value.trim();
      if (!destination) { pg.estimate.innerHTML=''; return; }
      try {
        const r = await fetch(`/estimate?destination=${encodeURIComponent(destination)}&days=${pg.days.value}&travelers=${pg.travelers.value}`);
        const j = await r.json();
        if (r.ok) pg.estimate.innerHTML = `Estimated total: $${j.minUSD}â€“$${j.maxUSD}<ul><li>Flights: $${j.flightUSD}</li><li>Hotels: $${j.hotelUSD}</li></ul>`;
      } catch { pg.estimate.innerHTML=''; }
      };
    const onPgInput = ()=>{ updatePgOut(); fetchPgEstimate(); };
    pg.travelers.addEventListener('input', onPgInput);
    pg.days.addEventListener('input', onPgInput);
    pg.destination.addEventListener('change', fetchPgEstimate);
    updatePgOut();

      const fields = {
        destination: out('fld-destination'),
        'dates.start': out('fld-start'),
        'dates.end': out('fld-end'),
        travelers: out('fld-travelers'),
        budgetUSD: out('fld-budget')
      };
      const reveal = (name)=>{
        if (name === 'dates' || name === 'dates.start' || name === 'dates.end') {
          fields['dates.start'].hidden = false;
          fields['dates.end'].hidden = false;
          f.start.required = true;
          f.end.required = true;
        } else if (fields[name]) {
          fields[name].hidden = false;
          if (f[name]) f[name].required = true;
        }
      };
      const revealFields = (arr)=>{
        arr.forEach(reveal);
        const first = arr[0];
        if (first) {
          const inp = first.startsWith('dates') ? (first === 'dates.end' ? f.end : f.start) : f[first];
          inp?.focus();
        }
      };
      const setLoading = (isLoading)=>{
        out('loading').hidden = !isLoading;
        out('submit').disabled = isLoading;
      };
    const showError = (msg, details)=>{
      out('err').hidden = false;
      out('errmsg').textContent = msg + (details ? ` â€” ${details}` : '');
    };
    const hideError = ()=>{ out('err').hidden = true; out('errmsg').textContent=''; };
    out('retry').addEventListener('click', ()=>{ hideError(); out('submit').focus(); });
    out('copy').addEventListener('click', async ()=>{
      try { await navigator.clipboard.writeText(out('raw').textContent); out('copied').hidden = false; setTimeout(()=>out('copied').hidden=true, 1200); } catch {}
    });

      const tInput = f.travelers;
      const bInput = f.budgetUSD;
    const tOut = out('travelersOut');
    const bOut = out('budgetOut');
      const estOut = out('estimate');
      const updateSliderOut = ()=>{
        tOut.textContent = tInput.value;
        bOut.textContent = bInput.value;
      };
      const fetchEstimate = async ()=>{
        const destination = f.destination.value.trim();
        const start = f.start.value;
        const end = f.end.value;
        const travelers = tInput.value;
        if (!destination || !start || !end) { estOut.innerHTML=''; estOut.hidden=true; return; }
        try {
          const r = await fetch(`/estimate?destination=${encodeURIComponent(destination)}&start=${start}&end=${end}&travelers=${travelers}`);
          const j = await r.json();
          if (r.ok) { estOut.hidden=false; estOut.innerHTML = `Estimated total: $${j.minUSD}â€“$${j.maxUSD}<ul><li>Flights: $${j.flightUSD}</li><li>Hotels: $${j.hotelUSD}</li></ul>`; }
        } catch { estOut.innerHTML=''; estOut.hidden=true; }
      };
      const onSlider = ()=>{ updateSliderOut(); fetchEstimate(); };
      tInput.addEventListener('input', onSlider);
      bInput.addEventListener('input', onSlider);
      ['destination','start','end'].forEach(n=>{ f[n].addEventListener('change', fetchEstimate); });
      updateSliderOut();
      fetch('/context').then(r=>r.json()).then(ctx=>{
        const d=ctx.defaults||{};
        if (d.travelers) { pg.travelers.value = d.travelers; tInput.value = d.travelers; }
        if (d.budgetUSD) { bInput.value = d.budgetUSD; }
        updatePgOut();
        updateSliderOut();
      }).catch(()=>{});

    pg.refine.addEventListener('click', ()=>{
      f.hidden = false;
      pg.card.hidden = true;
      revealFields(['destination','dates.start','dates.end','travelers','budgetUSD']);
      f.destination.value = pg.destination.value;
      f.travelers.value = pg.travelers.value;
      updateSliderOut();
    });

    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideError();
        const data = Object.fromEntries(new FormData(f).entries());
        data.travelers = Number(data.travelers||2);
        data.budgetUSD = Number(data.budgetUSD||2000);
        data.preferences = currentPrefs;
        setLoading(true);
        try {
          const r = await fetch('/suggest',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
          const j = await r.json();
          if (!r.ok) {
            if (Array.isArray(j?.details)) {
              revealFields(j.details.map(d=>d.field));
            } else {
              const details = j?.details?.map?.(d=>`${d.field}: ${d.message}`).join(', ');
              showError(j?.error || 'Request failed', details);
            }
            return;
          }
        out('out').hidden = false;
        out('summary').textContent = j.plan.summary;
        out('reasoning').textContent = j.reasoning || '';
        out('hotels').innerHTML = (j.plan.hotelIdeas||[]).map(h=>`<li><strong>${h.name}</strong> â€” ${h.area} (~$${h.estPricePerNightUSD}/night)</li>`).join('');
        out('flight').textContent = j.plan.flightNotes;
        out('todo').innerHTML = (j.plan.mustDo||[]).map(x=>`<li>${x}</li>`).join('');
        out('raw').textContent = JSON.stringify(j,null,2);
        // Update history panel
        try {
          const hr = await fetch('/history');
          const hist = await hr.json();
          out('hist').hidden = false;
          out('histlist').innerHTML = (hist||[]).slice().reverse().map(h=>{
            const { destination, dates, travelers, budgetUSD } = h.request || {};
            const sum = h.response?.plan?.summary || '';
            return `<li><strong>${destination}</strong> â€” ${dates?.start} â†’ ${dates?.end} â€¢ ${travelers} pax â€¢ $${budgetUSD}<br/><span class="muted">${sum}</span></li>`;
          }).join('');
        } catch {}
      } catch (e) {
        showError('Network or server error', e?.message);
      } finally {
        setLoading(false);
      }
    });

    const ambientToggle = out('ambientToggle');
    const ambientBox = out('ambient');
    const ambientList = out('ambientList');
    ambientToggle.addEventListener('change', async ()=>{
      if (ambientToggle.checked) {
        try {
          const r = await fetch('/suggestions');
          const j = await r.json();
          ambientBox.hidden = false;
          ambientList.innerHTML = (j||[]).map(s=>`<li><strong>${s.destination}</strong> â€” ${s.plan?.summary||''}</li>`).join('');
        } catch {
          ambientBox.hidden = true;
        }
      } else {
        ambientBox.hidden = true;
        ambientList.innerHTML = '';
      }
    });
  </script>
</body>
</html>
